name: ci

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  python-parity-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: |
            requirements-ci.txt

      - name: Install dependencies (strict)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip

          if [ ! -f requirements-ci.txt ]; then
            echo "ERROR: requirements-ci.txt missing. Generate it (pinned) and commit it." >&2
            exit 1
          fi

          python -m pip install -r requirements-ci.txt
          python -m pip check

      - name: Run parity harness smoke
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f tests/test_parity_harness_smoke.py ]; then
            echo "ERROR: tests/test_parity_harness_smoke.py not found." >&2
            exit 1
          fi

          python -m pytest -q tests/test_parity_harness_smoke.py

  rust:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Locate Cargo.toml
        id: cargo
        shell: bash
        run: |
          set -euo pipefail

          manifest=""

          # Preferred layout during migration
          if [ -f rust/Cargo.toml ]; then
            manifest="rust/Cargo.toml"
          else
            # If rust/ exists, search inside it first
            if [ -d rust ]; then
              candidates="$(find rust -maxdepth 4 -name Cargo.toml -not -path '*/target/*' -print || true)"
              count="$(printf "%s\n" "$candidates" | sed '/^$/d' | wc -l | tr -d ' ')"
              if [ "$count" -eq 1 ]; then
                manifest="$(printf "%s\n" "$candidates" | head -n 1)"
              elif [ "$count" -gt 1 ]; then
                echo "ERROR: Multiple Cargo.toml files found under rust/. Make this unambiguous." >&2
                echo "$candidates" >&2
                exit 1
              fi
            fi

            # Fallback: workspace at repo root
            if [ -z "$manifest" ] && [ -f Cargo.toml ]; then
              manifest="Cargo.toml"
            fi
          fi

          # Final fallback: find a single Cargo.toml near the root
          if [ -z "$manifest" ]; then
            candidates="$(find . -maxdepth 3 -name Cargo.toml -not -path '*/target/*' -print || true)"
            count="$(printf "%s\n" "$candidates" | sed '/^$/d' | wc -l | tr -d ' ')"
            if [ "$count" -eq 1 ]; then
              manifest="$(printf "%s\n" "$candidates" | head -n 1)"
              manifest="${manifest#./}"
            elif [ "$count" -gt 1 ]; then
              echo "ERROR: Multiple Cargo.toml files found near repo root. Make this unambiguous." >&2
              echo "$candidates" >&2
              exit 1
            fi
          fi

          if [ -z "$manifest" ]; then
            echo "ERROR: Could not find Cargo.toml. Expected rust/Cargo.toml, a single Cargo.toml under rust/, or Cargo.toml at repo root." >&2
            exit 1
          fi

          manifest="${manifest#./}"
          workspace_dir="$(dirname "$manifest")"
          if [ "$workspace_dir" = "." ]; then
            workspace_dir="."
          fi

          echo "manifest=$manifest" >> "$GITHUB_OUTPUT"
          echo "workspace_dir=$workspace_dir" >> "$GITHUB_OUTPUT"

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            ${{ steps.cargo.outputs.workspace_dir }} -> target

      - name: Cargo fmt (check)
        shell: bash
        run: |
          set -euo pipefail
          cargo fmt --manifest-path "${{ steps.cargo.outputs.manifest }}" --all -- --check

      - name: Cargo clippy (-D warnings)
        shell: bash
        run: |
          set -euo pipefail
          cargo clippy --manifest-path "${{ steps.cargo.outputs.manifest }}" --all-targets --all-features -- -D warnings

      - name: Cargo test
        shell: bash
        run: |
          set -euo pipefail
          cargo test --manifest-path "${{ steps.cargo.outputs.manifest }}" --all --all-features
